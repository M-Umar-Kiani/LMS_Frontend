<app-loader [isLoading]="isLoading"></app-loader>
<div class="dashboard-container">
  <div class="dashboard-header">
    <!-- Left Side -->
    <div class="header-left">
      <h2>Dashboard</h2>
      <br>
      <p>Overview of your library management system</p>
    </div>

    <!-- Right Side â€” Date Filter -->
    <div class="header-right">
      <div class="date-filter-wrapper">
        <select class="date-filter-select" [(ngModel)]="selectedRange" (change)="onRangeChange()">
          <option value="monthToDate">Month to Date</option>
          <option value="lastMonth">Last Month</option>
          <option value="lastThreeMonths">Last 3 Months</option>
          <option value="thisYear">This Year</option>
          <option value="lastYear">Last Year</option>
          <option value="custom">Custom Range</option>
        </select>

        <div class="date-range-box" *ngIf="selectedRange === 'custom'">
          <input type="date" [(ngModel)]="startDate" (change)="onCustomDateChange()" />
          <span>to</span>
          <input type="date" [(ngModel)]="endDate" (change)="onCustomDateChange()" />
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="card total">
      <h3>Total Books</h3>
      <p class="count">{{ bookCount }}</p>
    </div>
    <div class="card borrowed">
      <h3>Downloads</h3>
      <p class="count">{{ downloadedBooksCount }}</p>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card small-chart">
      <h3>Category Distribution</h3>

      <button class="card-download-btn" (click)="downloadDepartmentReportExcel()"
        [disabled]="!hasData(categoryWidgetData)" title="Download CSV">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M5 20h14v-2H5v2zm7-18v12l4-4h-3V4h-2v6H8l4 4z" />
        </svg>
      </button>

      <ng-container *ngIf="hasData(categoryWidgetData); else noCategory">
        <canvas id="categoryChart"></canvas>
      </ng-container>

      <ng-template #noCategory>
        <div class="no-data">No Data to Display</div>
      </ng-template>
    </div>

    <div class="chart-card small-chart">
      <h3>Books by Department</h3>

      <button class="card-download-btn" (click)="downloadDepartmentReportExcel()"
        [disabled]="!hasData(departmentWidgetData)" title="Download CSV">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M5 20h14v-2H5v2zm7-18v12l4-4h-3V4h-2v6H8l4 4z" />
        </svg>
      </button>

      <ng-container *ngIf="departmentWidgetData != null && departmentWidgetData.bookCount.length > 0; else noDept">
        <canvas id="deptChart"></canvas>
      </ng-container>

      <ng-template #noDept>
        <div class="no-data">No Data to Display</div>
      </ng-template>
    </div>

    <div class="chart-card small-chart">
      <h3>Monthly Activity</h3>

      <button class="card-download-btn" (click)="downloadCSV(monthilyActivityWidgetData, 'CategoryData')"
        [disabled]="!hasData(monthilyActivityWidgetData)" title="Download CSV">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M5 20h14v-2H5v2zm7-18v12l4-4h-3V4h-2v6H8l4 4z" />
        </svg>
      </button>

      <ng-container *ngIf="hasMonthlyActivityData(); else noActivity">
        <canvas id="activityChart"></canvas>
      </ng-container>

      <ng-template #noActivity>
        <div class="no-data">No Data to Display</div>
      </ng-template>
    </div>

    <div class="chart-card small-chart popular-card">
      <h3>Top Rated Books</h3>
      <!-- Check if there is data -->
      <table class="excel-table" *ngIf="popularBooks && popularBooks.length > 0; else noData">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Book</th>
            <th>Author</th>
            <th>Department</th>
            <th>Borrows</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let b of popularBooks">
            <td>{{ b.rank }}</td>

            <!-- Title column -->
            <td class="table-tooltip">
              {{ b.title | tooltip:15 }}
              <span class="table-tooltiptext" *ngIf="(b?.title?.length ?? 0) > 15">{{ b.title }}</span>
            </td>

            <!-- Author column -->
            <td class="table-tooltip">
              {{ b.author | tooltip:15 }}
              <span class="table-tooltiptext" *ngIf="(b?.author?.length ?? 0) > 15">{{ b.author }}</span>
            </td>

            <!-- Department column -->
            <td class="table-tooltip">
              {{ b.dept | tooltip:15 }}
              <span class="table-tooltiptext" *ngIf="(b?.dept?.length ?? 0) > 15">{{ b.dept }}</span>
            </td>

            <td><span class="badge green">{{ b.download }} times</span></td>
          </tr>
        </tbody>
      </table>

      <!-- Template to show if no data -->
      <ng-template #noData>
        <div class="no-data">No Data to Display</div>
      </ng-template>
    </div>
  </div>
</div>